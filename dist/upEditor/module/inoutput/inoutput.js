define(function(){var e=window.UP.Editor,t=window.UP.W.UI,n=null,i={};$("#projectName").on("blur",function(){e.projectName=$(this).val()}),$("#openProject").on("click",function(){chrome.fileSystem.chooseEntry({type:"openWritableFile",accepts:[{description:"*.sav",mimeTypes:["text/plain"],extensions:["sav"]}]},function(i){n=i,i.file(function(n){var i=new FileReader;i.onload=function(){var n=this.result;e=JSON.parse(n),r.loadConfig(),t.showToast("加载成功")},i.readAsText(n)})})}),$("#saveProject").on("click",function(){if(t.showProcess(),e.lastDate=t.dateFormate(new Date),null===n)chrome.fileSystem.chooseEntry({type:"saveFile",accepts:[{description:"*.json",mimeTypes:["text/plain"],extensions:["json"]}]},function(n){n.getFile(n.name,{create:!0},function(n){n.createWriter(function(n){n.write(new Blob([JSON.stringify(e)]),{type:"text/plain"}),t.updateProcess("加载完成","100"),setTimeout(function(){t.dismiss()},1e3)})})});else{var i=JSON.stringify(e).length;n.createWriter(function(n){n.onwrite=function(){n.truncate(i)},n.write(new Blob([JSON.stringify(e)]),{type:"text/plain"}),t.updateProcess("保存完成","100"),setTimeout(function(){t.dismiss()},2e3)})}}),$("#importProject").on("click",function(){var n="";n=e.projectName&&""!==e.projectName?e.projectName:"无标题";var a=r.getDomStr(e.page),o=a.substring(0,a.indexOf("</body>")),c=a.substring(a.indexOf("</body>")),s='<script src="http://wallet.95516.com/s/wl/webV2/commonModule/zepto.min.js"><\/script><script src="http://wallet.95516.com/s/wl/webV2/common/commonAll.js"><\/script><script>(function ($, UP) {    UP.W = UP.W || {};    var util = UP.W.Util || {};    var env = UP.W.Env || {};    var ui = UP.W.UI || {};    var app = UP.W.App || {};';$("#topRightShare").get(0).checked&&(s+=' app.onPluginReady(function () {\n       app.setNavigationBarRightButton("",env.currentPath + "./image/more_icon.png",function(){           app.showSharePanel({               title:"'+i.title+'",               desc:"'+i.desc+'",               picUrl: env.currentPath + "./image/shareIcon.png",               shareUrl: env.currentPath + location.href.split("/")[location.href.split("/").length - 1]           });       });   });'),s+='$(".linkButton[data-isShare=\'true\']").on("click",function(e){   app.onPluginReady(function () {\n           app.showSharePanel({               title:"'+i.title+'",               desc:"'+i.desc+'",               picUrl: env.currentPath + "./image/shareIcon.png",               shareUrl: env.currentPath + location.href.split("/")[location.href.split("/").length - 1]           });   });   e.preventDefault();    return false;});',s+="})(Zepto, window.UP = window.UP || {});<\/script>",a=o+s+c;var l=r.getJavaScript(e.page);e.lastDate=t.dateFormate(new Date);var p=!1;chrome.fileSystem.chooseEntry({type:"openDirectory"},function(i){i.createReader().readEntries(function(o){for(var c=0;c<o.length;c++)o[c].name===n&&(p=!0,n+="_new");t.showProcess("导出"),t.updateProcess("正在创建目录...",0),i.getDirectory(n,{create:!0},function(i){i.getDirectory("css",{create:!0},function(n){n.getFile("index.css",{create:!0},function(n){n.createWriter(function(n){n.write(new Blob([r.getStyleStr(e.page)]),{type:"text/plain"}),t.updateProcess("样式文件保存成功...",10,function(){setTimeout(function(){r.loadSuccess(i)},1e3)})})})}),i.getDirectory("js",{create:!0},function(e){e.getFile("resize.js",{create:!0},function(e){e.createWriter(function(e){e.write(new Blob([l]),{type:"text/plain"}),t.updateProcess("RESIZE文件保存成功...",10,function(){setTimeout(function(){r.loadSuccess(i)},1e3)})})})}),i.getFile("index.html",{create:!0},function(e){e.createWriter(function(e){e.write(new Blob([a]),{type:"text/plain"}),t.updateProcess("页面文件保存成功...",30,function(){r.loadSuccess(i)})})}),i.getDirectory("image",{create:!0},function(n){function a(){if(c<o)if(s[c].parent.indexOf("qrCode")>-1){var e=s[c].parent+".png";n.getFile(e,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){c++,a()},e.write(t.base64ToBlob(s[c].src),{type:"text/plain"})})})}else if(s[c].parent.indexOf("image")>-1){var e=s[c].parent+".png";n.getFile(e,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){c++,a()},e.write(t.base64ToBlob(s[c].src),{type:"text/plain"})})})}else if(s[c].parent.indexOf("linkButton")>-1&&s[c].src){var e=s[c].parent+".png";n.getFile(e,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){c++,a()},e.write(t.base64ToBlob(s[c].src),{type:"text/plain"})})})}else c++,a();else t.updateProcess("静态资源保存成功...",40,function(){r.loadSuccess(i)})}var o=e.page.length,c=1,s=new Array;s=e.page,s[0]&&s[0].shareData&&(n.getFile("more_icon.png",{create:!0},function(e){e.createWriter(function(e){e.write(t.base64ToBlob(s[0].shareData.rightBuutonImg),{type:"text/plain"})})}),n.getFile("shareIcon.png",{create:!0},function(e){e.createWriter(function(e){e.write(t.base64ToBlob(s[0].shareData.picUrl),{type:"text/plain"})})})),s[0]&&s[0].src&&""!==s[0].src&&n.getFile("bg.png",{create:!0},function(e){e.createWriter(function(e){e.write(t.base64ToBlob(s[0].src),{type:"text/plain"})})}),a()}),i.getFile(n+".sav",{create:!0},function(n){n.createWriter(function(n){n.write(new Blob([JSON.stringify(e)]),{type:"text/plain"}),t.updateProcess("保存配置成功...",10,function(){setTimeout(function(){r.loadSuccess(i)},2e3)})})})})})})}),$("#topRightShare").on("click",function(){if($(this).get(0).checked){var e=chrome.app.window.get("create");e?(e.close(),e.show()):chrome.app.window.create("../../html/shareEdit.html",{bounds:{width:480,height:320},resizable:!1,frame:"none"})}}),chrome.runtime.onMessage.addListener(function(t,n,r){"succeed"===t?(chrome.storage.local.get("shareData",function(t){i=t.shareData,i.rightBuutonImg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAU1JREFUWAntlDtOw0AQhrNrt6RKZ7nOAfzoQPTcATpOAA2IFC5QotwClHMQic6Pa/gEdInX/LPySHaIC4o1FDPSaHfHO55f3+7ObCYmBISAEBACQkAICAEh4JCA4n+naXppjHls2zammFKq1Fpv8zz/5D1jo8tcj4rGcfwEce+YLuEXnS8h9i4IgmNd16MiXeeqJEmuIG4PUQf4Cv4GJ7uFZ3Df87zrcySnyPVB6QEi6KhXVVVtMLJtoiii+ZqOHuMPilPkar5zEMDkSBSbjfX2cNyOvbizXD2o+A8Xml5rp4vu3KnZWG/P4Hsv7izXp1bSNM0NKmfdnePj4kdiaM9AWbeYItf2QbSKZ9ynDHVPj9yA0ktZlq/nBFLMda7tg9TnwjD8QL0FfA7/grA92st9URQ7rEftr3JHBckHISAEhIAQEAJCQAgIgd8Q+AYwAv2bZ1C8hgAAAABJRU5ErkJggg==",e.page[0].shareData=i}),r("00")):"failure"===t&&($("#topRightShare").attr("checked",!1),r("00"))});var r={loadConfig:function(){$("#projectName").val(e.projectName),$("#lastDate").text(e.lastDate),$("#projectAmount").text(e.projectAmount)},getStyleStr:function(e){var t="",n=e.length;for(key in e[0].style){t+=key+"{";var i=e[0].style[key];for(sheet in i)if(t+=sheet+":"+i[sheet]+";",0!==i[sheet]&&"background-image"!==sheet&&i[sheet].indexOf("px")>-1){var r=parseInt(i[sheet]);i[sheet]=0==r?0:r/100+"rem"}t+="}"}for(var a=1;a<n;a++){var o=e[a].style;for(key in o){t+="#"+e[a].parent+" "+key+"{";var c=o[key];for(sheet in c)if(t+=sheet+":"+c[sheet]+";",0!==c[sheet]&&"box-shadow"!==sheet&&"background-image"!==sheet&&c[sheet].indexOf("px")>-1){var s=parseInt(c[sheet]);c[sheet]=0==s?0:s/100+"rem"}t+="}"}}return t},getDomStr:function(t){var n="";n=t[0].pageStr;var i=t.length,r="";r=e.projectName&&""!==e.projectName?e.projectName:"无标题",n=n.replace("<title></title>","<title>"+r+"</title>");for(var a=1;a<i;a++){var o=t[a].href,c="./image/"+t[a].parent+".png",s=t[a].pageStr;if(s.indexOf("linkButton")>-1){var l=s.substring(0,3)+'href = "'+o+'" '+s.substring(3,s.length);n=n.replace('<div id="'+t[a].parent+'"></div>','<div id="'+t[a].parent+'">'+l+"</div>")}else if(s.indexOf("qrCode")>-1||s.indexOf("image")>-1){var p=s.substring(0,5)+'src = "'+c+'" '+s.substring(5,s.length);n=n.replace('<div id="'+t[a].parent+'"></div>','<div id="'+t[a].parent+'">'+p+"</div>")}else n=n.replace('<div id="'+t[a].parent+'"></div>','<div id="'+t[a].parent+'">'+t[a].pageStr+"</div>")}return n},getJavaScript:function(e){return e[0].js},loadSuccess:function(e){t.dismiss(),t.showAlert("系统提示","导出成功","确认",null,function(){t.dismiss()},null)}}});